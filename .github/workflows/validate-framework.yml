name: QAQC Framework Validation

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]

jobs:
  # ===================================
  # Validate Documentation
  # ===================================
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in Markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

      - name: Lint Markdown files
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.json
          ignore_files: node_modules/

      - name: Check documentation completeness
        run: |
          echo "Checking required documentation files..."
          required_files=(
            "README.md"
            "QAQC_STANDARDS.md"
            "CODE_REVIEW_CHECKLIST.md"
            "SECURITY_GUIDE.md"
            "PROJECT_STRUCTURE.md"
            "CONTRIBUTING.md"
            "LICENSE"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "❌ Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          else
            echo "✅ All required documentation files present"
          fi

  # ===================================
  # Validate Templates
  # ===================================
  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate YAML files
        run: |
          pip install yamllint
          yamllint .github/workflows/*.yml
          yamllint templates/*.yml templates/*.yaml 2>/dev/null || true

      - name: Validate JavaScript/TypeScript configs
        run: |
          npm install -g eslint prettier

          # Check if templates are valid JS syntax
          for file in templates/*.js; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              node --check "$file" || exit 1
            fi
          done

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -not -path "./node_modules/*"); do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              python -m json.tool "$file" > /dev/null || exit 1
            fi
          done

      - name: Validate Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: templates/Dockerfile
          failure-threshold: warning

      - name: Validate Docker Compose
        run: |
          # Install docker-compose
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

          # Validate docker-compose file
          docker-compose -f templates/docker-compose.yml config > /dev/null

      - name: Validate Python configs
        run: |
          pip install toml

          # Validate pyproject.toml
          python -c "import toml; toml.load('templates/pyproject.toml')" || exit 1

          echo "✅ All templates validated successfully"

  # ===================================
  # Security Scan
  # ===================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ===================================
  # Check Code Examples
  # ===================================
  validate-code-examples:
    name: Validate Code Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract and validate Python code examples
        run: |
          echo "Extracting Python code blocks from markdown files..."
          pip install markdown-code-blocks

          # This is a placeholder - would need actual implementation
          # to extract and test code blocks from markdown
          echo "✅ Python examples validation placeholder"

      - name: Extract and validate JavaScript code examples
        run: |
          echo "Extracting JavaScript code blocks from markdown files..."
          # This is a placeholder - would need actual implementation
          echo "✅ JavaScript examples validation placeholder"

  # ===================================
  # Spell Check
  # ===================================
  spell-check:
    name: Spell Check Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run spell check
        uses: rojopolis/spellcheck-github-actions@0.35.0
        with:
          config_path: .github/spellcheck-config.yml
          task_name: Markdown

  # ===================================
  # Final Report
  # ===================================
  validation-report:
    name: Generate Validation Report
    runs-on: ubuntu-latest
    needs: [validate-docs, validate-templates, security-scan, validate-code-examples]
    if: always()

    steps:
      - name: Generate report
        run: |
          echo "# QAQC Framework Validation Report" > report.md
          echo "" >> report.md
          echo "## Status" >> report.md
          echo "- Documentation: ${{ needs.validate-docs.result }}" >> report.md
          echo "- Templates: ${{ needs.validate-templates.result }}" >> report.md
          echo "- Security: ${{ needs.security-scan.result }}" >> report.md
          echo "- Code Examples: ${{ needs.validate-code-examples.result }}" >> report.md

          cat report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: report.md
          retention-days: 30

      - name: Check if all validations passed
        run: |
          if [[ "${{ needs.validate-docs.result }}" != "success" ]] || \
             [[ "${{ needs.validate-templates.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.validate-code-examples.result }}" != "success" ]]; then
            echo "❌ Some validations failed"
            exit 1
          else
            echo "✅ All validations passed successfully"
          fi
